---
title: 'Chapter 6: Data Visualisation with R'
description:
  'This chapter will give you an introduction to the R graphics system and teach you how to get started with using the ggplot2 package for drawing all kind of plots.'
prev: /chapter5
next: /chapter6
type: chapter
id: 6
output:
  teachr::teachr_chapter:
  # html_document:
  #   self_contained: false
  #md_document
---

```{r setup, include = FALSE}
library(teachr)
knitr::opts_chunk$set(fig.path = "ch6/",
                      fig.retina = 2,
                      fig.width = 6, 
                      fig.height = 4,
                      fig.align = "center",
                      cache = TRUE,
                      cache.path = "cache/",
                      message = FALSE,
                      warning = FALSE)
show_target_plot <- TRUE
read_lines <- ifelse(show_target_plot,
                     readLines,
                     function(x) "")
```


<exercise id="1" title="R Graphics" type="slides">

`r slides("chapter6_01_rgraphics")`

</exercise>

<exercise id="2" title="Test your knowledge of R Graphics">

Which of the following is a contributed R package?

```{r, echo = FALSE, results = "asis"}
cat(mc_opts("ggplot2" = "That's correct! ggplot2 was developed by Hadley Wickham as part of his PhD.",
         "grid" = "No, this is a core package so it's already installed.",
         "graphics" = "No, this a core package and loads automatically when you launch R.",
         "grDevices" = "No, this a core package and loads automatically when you launch R.",
         correct = 1))
```

Which R package actually renders the graphics in R?

```{r, echo = FALSE, results = "asis"}
cat(mc_opts("ggplot2" = "No, that's incorrect.",
         "grid" = "No, that's incorrect.",
         "graphics" = "No, that's incorrect.",
         "grDevices" = "Yes, that's right!",
         correct = 4))
```

Remember that there are two primary graphic models in R: the base and grid graphics. Which one is ggplot2 using?

```{r, echo = FALSE, results = "asis"}
cat(mc_opts("base" = "No, that's incorrect.",
         "grid" = "Yes that's right! Well done!",
         correct = 2))
```


</exercise>



<exercise id="3" title="Getting started with ggplot2" type="slides">

`r slides("chapter6_02_ggplot2intro")`

</exercise>

<exercise id="4" title="Plotting two or more variables with ggplot2" type="slides">

`r slides("chapter6_03_ggplot2next")`

</exercise>


<exercise id="5" title="Make basic plots with ggplot2">

For the following questions we are going to use `BudgetFood` data from the `Ecdat` package which contains the budget share of food for Spanish households. You can load the dataset and see the structure of the data below.

```{r, message = FALSE, warning = FALSE}
library(Ecdat)
str(BudgetFood)
```
The meaning of the variables are described below:

* `wfood`: percentage of total expenditure which the household has spent on food
* `totexp`: total expenditure of the household
* `age`: age of reference person in the household
* `size`: size of the household
* `town`: size of the town where the household is placed categorized into 5 groups: 1 for small towns, 5 for big ones
* `sex`: sex of reference person (man,woman)

Try to recreate the scatter plot below. Is there anything unusual that you notice about the plot?

```{r plot4A, code = read_lines("../exercises/solution_06_04A.R"), echo = FALSE}
```

Note: the **submit button doesn't do anything** in this chapter. You will need to eyeball your output plot is the same as the target plots for all questions. 

```{teachr 06_04A, outdir = "../exercises"}
library(ggplot2)
library(Ecdat)
ggplot(data = <<BudgetFood>>, 
       mapping = aes(x = <<size>>, 
                     y = <<totexp>>)) +
  geom_<<point>>()

---
  
Hint: The scatter plots are created using `geom_point`.

```

```{r plot4B, code = read_lines("../exercises/solution_06_04B.R"), echo = FALSE}
```

```{teachr 06_04B, outdir = "../exercises"}
library(ggplot2)
library(Ecdat)
ggplot(data = <<BudgetFood>>, 
       mapping = aes(x = <<size>>, 
                     y = <<totexp>>)) +
  geom_<<hex>>()

---
  
Hint: The hex plots are created using `geom_hex`.
```


```{r plot4C, code = read_lines("../exercises/solution_06_04C.R"), echo = FALSE}
```

```{teachr 06_04C, outdir = "../exercises"}
library(ggplot2)
library(Ecdat)
ggplot(data = <<BudgetFood>>, 
       mapping = aes(x = <<sex>>, 
                     y = <<age>>)) +
  geom_<<boxplot>>()

---
  
Hint: The five number summary is often graphically depicted by a boxplot. 
```


```{r plot4D, code = read_lines("../exercises/solution_06_04D.R"), echo = FALSE}
```

```{teachr 06_04D, outdir = "../exercises"}
library(ggplot2)
library(Ecdat)
ggplot(data = <<BudgetFood>>, 
       mapping = aes(x = <<factor(town)>>, 
                     y = <<totexp>>)) +
  geom_<<violin>>()

---
  
Hint: what do you notice about the x-axis scale? Do you perhaps need to convert `town`?
```

```{r plot4E, code = read_lines("../exercises/solution_06_04E.R"), echo = FALSE}
```
```{teachr 06_04E, outdir = "../exercises"}
library(ggplot2)
library(Ecdat)
ggplot(data = <<BudgetFood>>, 
       mapping = aes(x = <<wfood>>)) +
  geom_<<histogram>>(binwidth = 0.001)

---
  
Hint: this plot is called a histogram.

```

```{r plot4F, code = read_lines("../exercises/solution_06_04F.R"), echo = FALSE}
```
```{teachr 06_04F, outdir = "../exercises"}
library(ggplot2)
library(Ecdat)
ggplot(data = <<BudgetFood>>, 
       mapping = aes(x = <<wfood>>))  +
  geom_density(aes(y = <<after_stat(count)>>))

---

Hint: this is a density plot but the y-axis is showing counts. What did `after_stat` function do?
    
```

</exercise>


<exercise id="6" title="Multiple layers in ggplot2"  type="slides">
`r slides("chapter6_04_ggplot2layers")`
</exercise>


<exercise id="7" title="Practice creating multiple layers">

We are again going to use the `BudgetFood` data from the `Ecdat` package to make the plots.


Try to recreate the scatter plot below. Is there anything that unusual that you notice about the plot?

```{r plot6A, code = read_lines("../exercises/solution_06_06A.R"), echo = FALSE}
```
```{teachr 06_06A, outdir = "../exercises"}
library(ggplot2)
library(Ecdat)
ggplot(data = <<BudgetFood>>, 
       mapping = aes(x = <<totexp>>)) +
  geom_<<histogram>>(aes(y = after_stat(density))) +
  geom_<<density>>(color = "red")
```

```{r plot6B, code = read_lines("../exercises/solution_06_06B.R"), echo = FALSE}
```
```{teachr 06_06B, outdir = "../exercises"}
library(ggplot2)
library(Ecdat)
ggplot(data = <<subset(BudgetFood, !is.na(sex))>>, 
       mapping = aes(x = <<sex>>,
                     y = <<age>>)) +
  geom_<<violin>>(<<aes(fill = sex)>>) +
  geom_<<boxplot>>(<<width>> = 0.1) 
```

```{r plot6C, code = read_lines("../exercises/solution_06_06C.R"), echo = FALSE}
```
```{teachr 06_06C, outdir = "../exercises"}
library(ggplot2)
library(Ecdat)
ggplot(data = <<subset(BudgetFood, size < 30)>>, 
       mapping = aes(x = <<size>>,
                     y = <<totexp>>)) +
  geom_<<point>>() +
  geom_<<smooth>>(color = "red",
                  method = loess,
                  formula = y ~ x)
```
```{r plot6D, code = read_lines("../exercises/solution_06_06D.R"), echo = FALSE, cache = FALSE}
```
```{teachr 06_06D, outdir = "../exercises"}
library(ggplot2)
library(Ecdat)
ggplot(data = <<subset(BudgetFood, !is.na(sex))>>, 
       mapping = aes(x = <<sex>>)) +
  geom_<<bar>>() +
  geom_<<text>>(aes(label = <<after_stat(count)>>),
                 vjust = -0.3,
                 stat = <<"count">>)
```

```{r plot6E, code = read_lines("../exercises/solution_06_06E.R"), echo = FALSE, cache = FALSE}
```
```{teachr 06_06E, outdir = "../exercises"}
library(tidyverse)
library(Ecdat)
dat <- BudgetFood %>% 
  filter(!is.na(sex)) %>% 
  group_by(town, sex) %>% 
  summarise(totexp = mean(totexp))

<<ggplot()>> +
  geom_<<col>>(data = subset(dat, sex=="woman"),
               aes(x = <<factor(town)>>,
                   y = <<totexp>>,
                  <<fill = "woman">>)) +
  geom_<<col>>(data = subset(dat, sex=="man"),
               aes(x = <<factor(town)>>,
                   y = <<-totexp>>,
                  <<fill = "man">>))
```


</exercise>

<exercise id="8" title="Scales and guides in ggplot2"  type="slides">
`r slides("chapter6_05_ggplot2scales")`
</exercise>

<exercise id="9" title="Practice changing scales and guides.">


</exercise>

<exercise id="10" title="Multiple plots in one figure"  type="slides">
`r slides("chapter6_06_ggplot2facet")`
</exercise>

<exercise id="11" title="Practice making multiple subplots.">

```{r plot7A, code = read_lines("../exercises/solution_06_10A.R"), echo = FALSE, cache = FALSE}
```
```{teachr 06_10A, outdir = "../exercises"}
ggplot(BudgetFood, aes(x = <<age>>)) + 
  geom_histogram(data = <<select(BudgetFood, -town)>>,
                 fill = "grey", binwidth = 1,
                 aes(y = after_stat(density))) +
  geom_histogram(aes(y = after_stat(density)),
                 binwidth = 1) +
  geom_density(color = "red") +
  facet_<<wrap(~town)>>
```



```{r plot7B, code = read_lines("../exercises/solution_06_10B.R"), echo = FALSE, cache = FALSE}
```
```{teachr 06_10B, outdir = "../exercises"}
ggplot(subset(BudgetFood, !is.na(sex)), aes(age)) +
  geom_histogram(aes(y = <<after_stat(density)>>)) +
  geom_text(x = 35, y = 0.035, 
            data = function(.data) .data %>% 
              group_by(sex, town) %>% 
              count(),
            aes(label = n)) +
  facet_<<grid(sex ~ town)>>
```



```{r plot7C, code = read_lines("../exercises/solution_06_10C.R"), echo = FALSE, cache = FALSE}
```
```{teachr 06_10C, outdir = "../exercises"}
library(patchwork)
g1 <- ggplot(BudgetFood, 
             aes(factor(size), wfood, color = sex)) +
  geom_boxplot() 

g2 <- ggplot(BudgetFood, 
             aes(factor(size), totexp, color = sex)) +
  geom_boxplot() + 
  scale_y_log10()

# combine the plot as one figure 
<<g1 / g2 + plot_layout(guides = "collect")>>
```


</exercise>

<exercise id="12" title="Customise the look with themes in ggplot2"  type="slides">
`r slides("chapter6_06_ggplot2theme")`
</exercise>

<exercise id="13" title="Make pretty plots">

```{r plot6, code = read_lines("../exercises/solution_06_10A.R"), echo = FALSE, cache = FALSE}
```
```{teachr 06, outdir = "../exercises"}
ggplot(BudgetFood, aes(x = <<age>>)) + 
  geom_histogram(data = <<select(BudgetFood, -town)>>,
                 fill = "grey", binwidth = 1,
                 aes(y = after_stat(density))) +
  geom_histogram(aes(y = after_stat(density)),
                 binwidth = 1) +
  geom_density(color = "red") +
  facet_<<wrap(~town)>>
```

</exercise>
